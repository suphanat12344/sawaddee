<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤</title>
  <style>
    body {
      background: #101010;
      color: #fff;
      text-align: center;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    video, canvas {
      border: 1px solid #444;
      margin-top: 10px;
      width: 640px;
      height: 480px;
    }
  </style>

  <!-- ‡πÇ‡∏´‡∏•‡∏î MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
</head>

<body>
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏à‡πà‡∏∞</h2>
  <p id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>

  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <audio id="alarm" src="alarm.mp3" preload="auto"></audio>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const alarm = document.getElementById("alarm");

    let soundEnabled = false;

  
    document.body.addEventListener("click", () => {
      alarm.play().then(() => {
        alarm.pause();
        alarm.currentTime = 0;
        soundEnabled = true;
        statusEl.innerText = "üîä ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ)";
        console.log("‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }).catch(err => {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á:", err);
        statusEl.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
      });
    }, { once: true });

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await new Promise(r => (video.onloadedmetadata = r));
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        statusEl.innerText = "‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á)";
      } catch (err) {
        statusEl.innerText = "‚ùå ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message;
      }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ FaceMesh
    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6,
    });

    faceMesh.onResults(onResults);

    function euclidean(a, b) {
      return Math.sqrt(
        Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2)
      );
    }

    function getEAR(eye) {
      const A = euclidean(eye[1], eye[5]);
      const B = euclidean(eye[2], eye[4]);
      const C = euclidean(eye[0], eye[3]);
      return (A + B) / (2.0 * C);
    }

    let closedFrames = 0;
    const EAR_THRESHOLD = 0.21; 
    const FRAME_THRESHOLD = 8; 
    let lastAlarm = 0;

    function onResults(results) {
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];

        drawConnectors(ctx, landmarks, FACEMESH_LEFT_EYE, { color: "#00FF00", lineWidth: 1 });
        drawConnectors(ctx, landmarks, FACEMESH_RIGHT_EYE, { color: "#00FF00", lineWidth: 1 });

        // ‡∏î‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏î‡∏ß‡∏á‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤
        const leftEyeIdx = [33, 160, 158, 133, 153, 144];
        const rightEyeIdx = [362, 385, 387, 263, 373, 380];
        const leftEye = leftEyeIdx.map(i => landmarks[i]);
        const rightEye = rightEyeIdx.map(i => landmarks[i]);

        const leftEAR = getEAR(leftEye);
        const rightEAR = getEAR(rightEye);
        const ear = (leftEAR + rightEAR) / 2.0;

        if (ear < EAR_THRESHOLD) {
          closedFrames++;
        } else {
          closedFrames = 0;
        }

        statusEl.innerText = `EAR: ${ear.toFixed(3)} | ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤ ${closedFrames} ‡πÄ‡∏ü‡∏£‡∏°`;

        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô threshold ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        if (closedFrames >= FRAME_THRESHOLD) {
          const now = Date.now();
          if (now - lastAlarm > 4000) {
            if (soundEnabled) {
              alarm.play().catch(e => console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á:", e));
              console.log("üö® ALARM Triggered!");
            } else {
              console.warn("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            }
            lastAlarm = now;
            statusEl.innerText = "üö® ‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏ô‡∏≤‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!";
          }
        }
      } else {
        statusEl.innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
      }

      ctx.restore();
    }

    const camera = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480,
    });

    startCamera().then(() => camera.start());
  </script>
</body>
</html>